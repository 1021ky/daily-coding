services:
  # TODO: 各サービスの役割と、なぜそういう実装になっているか説明を書く

  # 開発環境兼、ビルドする環境
  dev:
    build:
      context: .
      target: dev
    working_dir: /app
    volumes:
      - .:/app
      - pnpm-store:/root/.local/share/pnpm/store
      - node_modules:/app/node_modules
    command: pnpm dev

  # テスト環境
  # テストを実行するためにライブラリがインストールされている
  test:
    build:
      context: .
      target: dev
    working_dir: /app
    volumes:
      - .:/app
      - pnpm-store:/root/.local/share/pnpm/store
      - node_modules:/app/node_modules
    command: pnpm test

  # プロダクション環境
  # 本番環境用に最適化されたビルド
  prod:
    build:
      context: .
      target: runner
    working_dir: /app
    command: node dist/index.js

volumes:
  pnpm-store:
  node_modules: